# line_-alarm

## 背景
朝起きれない +  
推しに起こされたい +    
友達に「明日まじで起きなきゃやばいからLineで起こして」「起きてなさそうだったらメッセージ爆撃して」というやつ +  
朝メールとかLine返すと意外と目覚めがち

（時間あるとき文章としてまとめる）

## できること
<img width="433" alt="目覚ましbot" src="https://user-images.githubusercontent.com/69378772/129932386-8e530fe1-e180-4f10-8c86-6968cb3a90ce.png">
こんな感じです．メッセージで設定時刻を言うとその時間にメッセージ爆撃してきます．起きたというと止まります．アイコンが手書きのゾロリになっていますが，これはLine開発者アカウントのところから推しの画像に変更します．

## 使用方法
認識されるメッセージは4種類

- 時刻設定  
__設定  
  (時間):(分)__  
  でメッセージを送るとアラーム時刻が設定されます．既にされている場合は上書きされます
- 確認  
__確認__  
 と送ると設定されているアラーム時刻を確認できます．
- キャンセル   
__キャンセル__  
  と送るとアラームを解除します
- ストップ   
__起きた__  
  アラームが鳴ってる（メッセージが立て続けに送られてきているときに）「起きた」と送ると止まります．起きれてえらいとほめてくれます

## 構成
pythonのプログラムを走りっぱなしにして置く環境がないので，herokuの無料枠を借りています（あとLineのWebhockで叩ける条件としてhttpsであることがあるが，ssl認証とかやったことがないし）．  
とある事情からheroku run main.pyの使い方（コード走りっぱなし）にはできないので，HTTPリクエストでたたくと処理を行うようにしておいてGASで定期実行させます．これによって設定された時刻にメッセージ送信を行います．  
- メッセージが送られてきたときの処理  webhockというLINE側が用意している機能というか仕組みでメッセージが送られてきたときに関数を実行します．初めてのメッセージだった場合はデータベースに「ユーザーID，（アラームが設定されているか=False），（設定時刻=適当）」を追加します．使用方法に示したメッセージに該当する場合はこれらの値を変更することで動作します．データベースについては明るくないですがユーザーIDを主キーにしておけば2重登録とかはないはず．ユーザーIDはLineAPIから取得してます．
- 定期実行  ５秒間隔でGASから実行されます．データベースに登録されているIDすべてについて「いまアラームを鳴らすべき時刻か」「アラームが設定されているか(boolean)がTrueか」を判定してメッセージを送ります．
![名称未設定ファイル](https://user-images.githubusercontent.com/69378772/129939978-1b69bf57-6654-4a7d-bb68-1834369093ac.png)

## 含まれるプログラム
これをherokuにおくだけで動くわけではないです．これの上位としてurlがたたかれたときにどの関数を呼ぶかなどの処理が書いてある層が必要です．  
herokuの無料枠は1つのアプリケーションしか基本使えないため，この上位の部分は別のアプリケーションと同居させて疑似的に複数のサービスとして使っているので公開できません．  
（上位の層はほとんどdjangoのサンプルそのままでよい）


## 今後の展望
起こすセリフやほめるセリフの変更をメッセージから「セリフ追加　～～」などで行えるようにしたいです．このキャラはこんなセリフ言わない！という解釈違いを起こさないために．  
実は展望というほど遠い話ではなくて，ちょこっと実装するだけだがやる気でず．~~結局現状自分用にしか使わないのでセリフ追加はプログラム書き換えのほうが楽だし．~~  
データベースの4個目の要素にスペース区切りの文字列でセリフ群をつける．そのうちやる．セリフ群のなかからランダムで送ってくるようにする（「起きて」連打は人間味に欠ける）

## 公開先
LineAPIの無料枠は1か月に1000通（恐ろしく少ない）しか送れないという縛りがあるのでとりあえず公開しません．(わざわざマルチユーザーで使えるように実装したのに...) 　

アラームとして使ったら5秒に1通だから30秒で止めたとしても6通，設定に5通くらいと考えても1日約10通．3人で使ったら止まっちゃうので．
